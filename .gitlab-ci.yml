# SPDX-License-Identifier: MIT OR LGPL-2.0-or-later
# SPDX-FileCopyrightText: 2017 Claudio Andr√© <claudioandre.br@gmail.com>
---
include:
  - remote: 'https://gitlab.freedesktop.org/freedesktop/ci-templates/-/raw/7ea696055e322cc7aa4bcbe5422b56a198c4bdff/templates/alpine.yml'

stages:
  - deploy

#############################################
#          Create CI Docker Images          #
#############################################
.Docker image template: &create_docker_image
  image: registry.freedesktop.org/freedesktop/ci-templates/x86_64/buildah:2020-10-30.1
  stage: deploy
  only:
    variables:
      - $CRON_TASK == "BUILD_CI_IMAGES"

  script:
    # Newer versions of podman/buildah try to set overlayfs mount options when
    # using the vfs driver, and this causes errors.
    - sed -i '/^mountopt =.*/d' /etc/containers/storage.conf

    # Where the real magic happens
    - buildah bud -f $DOCKERFILE -t "$CI_REGISTRY_IMAGE:$CI_JOB_NAME" $ARGS

    # Prepare to publish
    - buildah tag "$CI_REGISTRY_IMAGE:$CI_JOB_NAME" "$CI_REGISTRY_IMAGE:job-${CI_JOB_ID}_$CI_JOB_NAME"
    - buildah images
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

    # Publish (if running on a schedule)
    - |
      if [[ "$CI_PIPELINE_SOURCE" == "schedule" ]]; then
        buildah push "$CI_REGISTRY_IMAGE:$CI_JOB_NAME"
        buildah push "$CI_REGISTRY_IMAGE:job-${CI_JOB_ID}_$CI_JOB_NAME"
      fi

.Docker variables: &docker_variables
  STORAGE_DRIVER: vfs
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot

fedora.mozjs91:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile
    ARGS: --build-arg MOZJS_BUILDDEPS=mozjs78

fedora.mozjs91-debug:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile.debug
    ARGS: --build-arg MOZJS_BUILDDEPS=mozjs78
