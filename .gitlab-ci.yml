# SPDX-License-Identifier: MIT OR LGPL-2.0-or-later
services:
  - docker

stages:
- deploy

#############################################
#          Create CI Docker Images          #
#############################################
.Docker image template: &create_docker_image
  image: registry.fedoraproject.org/fedora:32
  stage: deploy

  script:
    - dnf install -y buildah runc

    # Newer versions of podman/buildah try to set overlayfs mount options when
    # using the vfs driver, and this causes errors.
    - sed -i '/^mountopt =.*/d' /etc/containers/storage.conf

    # Where the real magic happens
    - buildah bud --isolation=chroot -f $DOCKERFILE -t "$IMAGE_NAME" $ARGS

    # Prepare to publish
    - buildah tag "$IMAGE_NAME" "$IMAGE_JOB_NAME"
    - buildah images
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

    # Publish
    - |
      buildah push "$IMAGE_NAME"
      buildah push "$IMAGE_JOB_NAME"

.Docker variables: &docker_variables
  IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_JOB_NAME
  IMAGE_JOB_NAME: $CI_REGISTRY_IMAGE:job-${CI_JOB_ID}_$CI_JOB_NAME
  STORAGE_DRIVER: vfs
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot

alpine.cpplint:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile.alpine.cpplint

fedora.mozjs68:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile

fedora.mozjs68-debug:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile.debug

fedora.mozjs78:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile
    ARGS: --build-arg MOZJS_BRANCH=mozjs78 --build-arg MOZJS_BUILDDEPS=mozjs78 --build-arg BUILD_OPTS=

fedora.mozjs78-debug:
  <<: *create_docker_image
  variables:
    <<: *docker_variables
    DOCKERFILE: test/extra/Dockerfile.debug
    ARGS: --build-arg MOZJS_BRANCH=mozjs78 --build-arg MOZJS_BUILDDEPS=mozjs78 --build-arg BUILD_OPTS=
